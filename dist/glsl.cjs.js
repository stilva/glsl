"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){_defineProperty(e,t,r[t])})}return e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,i=e}finally{try{n||null==s.return||s.return()}finally{if(a)throw i}}return r}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function getCanvas(e,t){var r=Object.assign({antialias:!1},t);if(e instanceof HTMLCanvasElement){var n=_objectSpread({},r,{height:e.height,width:e.width});return new Canvas(e,n)}if(Array.isArray(e)){var a=_objectSpread({},r,{height:e[1],width:e[0]}),i=document.createElement("canvas");return new Canvas(i,a)}throw new Error("getCanvas expects an HTMLCanvasElement or an Array [width, height]")}var Canvas=function(){function e(t,r){var n=r.antialias,a=r.height,i=r.width,o=r.webglVersion;_classCallCheck(this,e),this._canvas=t;try{this._context=t.getContext(o,{antialias:n})}catch(e){throw new Error("Error while getting the context. ".concat(e.message))}t.width=i,t.height=a}return _createClass(e,[{key:"context",get:function(){return this._context}},{key:"node",get:function(){return this._canvas}},{key:"height",get:function(){return this._canvas.height}},{key:"width",get:function(){return this._canvas.width}}]),e}(),FLOAT_VARIABLES={float:"uniform1f",vec2:"uniform2fv",vec3:"uniform3fv",vec4:"uniform4fv"};function variableHelper(e,t,r){var n=asArray(t),a=_slicedToArray(getType(n,r),2),i=a[0],o=a[1],s=FLOAT_VARIABLES[i];return{name:e,linked:!1,value:n,type:i,size:o,location:"".concat(e,"Location"),locationType:s}}function textureHelper(e,t,r){return{apply:noop,name:e,index:t,pSource:"string"==typeof r?pGetImage(r):r instanceof Blob?pGetBlob(r).then(pGetImage):Promise.resolve(r),linked:!1}}function asArray(e){return Array.isArray(e)?e:[e]}function pGetImage(e){var t=new Image;return t.crossOrigin="Anonymous",new Promise(function(r){t.addEventListener("load",function(e){return r(t)}),t.src=e})}function pGetBlob(e){var t=new FileReader;return new Promise(function(r){t.addEventListener("load",function(e){r(e.target.result)}),t.readAsDataURL(e)})}function getType(e,t){return t?[t,"[".concat(e.length,"]")]:1===e.length?["float",""]:["vec".concat(e.length),""]}function noop(){}var WEBGL2="webgl2",PRECISION=["lowp","mediump","highp"],VALID_WEBGL_VERSIONS=new Set(["webgl",WEBGL2]),GLSL=function(){function e(t,r){if(_classCallCheck(this,e),this._destroyed=!1,this._options=_objectSpread({antialias:!1,precision:1,webglVersion:WEBGL2},r),!VALID_WEBGL_VERSIONS.has(this._options.webglVersion))throw new Error("Constructor option is invalid: webglVersion needs to be either ".concat(Array.from(VALID_WEBGL_VERSIONS).join(" or ")));this._canvas=getCanvas(t,this._options),this._gl=this._canvas.context,this._gl.viewport(0,0,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight),this._locations={},this._variables={},this._textures={},this._vertex="".concat(this.isWebgl2?"#version 300 es\n    in vec2 a_position;":"attribute vec2 a_position;","\n\n\t\tvoid main() {\n\t\t\tgl_Position = vec4(a_position, 0, 1);\n\t\t}"),this._initTime=Date.now(),this.addVariable("u_time",0),this.resize=this.addVariable("u_resolution",[this._canvas.width,this._canvas.height])}return _createClass(e,[{key:"canvas",get:function(){return this._canvas.node}},{key:"isWebgl2",get:function(){return this._options.webglVersion===WEBGL2}}]),_createClass(e,[{key:"addVariable",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(this._variables.hasOwnProperty(e))throw new Error("Variable ".concat(e," has already been added to this instance."));return this._variables[e]=variableHelper(e,t,n),function(t){var n=r._variables[e],a=n.location,i=n.locationType;r._variables[e].value=t,r._gl[i](r._locations[a],r._variables[e].value)}}},{key:"addTexture",value:function(e,t){var r=this;if(this._textures.hasOwnProperty(e))throw new Error("Texture ".concat(e," has already been added to this instance."));var n=Object.keys(this._textures).length;return this._textures[e]=textureHelper(e,n,t),function(t){r._textures[e].apply(t)}}},{key:"fragment",value:function(e){for(var t=this,r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];var i=Array.isArray(e)?e:[e];if(n.length!==i.length-1)throw new Error("The fragment shader provided has an invalid amount of arguments");this._fragment="".concat(this.isWebgl2?"#version 300 es":"","\n    precision ").concat(PRECISION[this._options.precision]," float;\n\t\t\n\t\t").concat(stringifyVariables(this._variables),"\n\t\t\n\t\t").concat(stringifyTextures(this._textures),"\n\t\t\n\t\t").concat(i.reduce(function(e,t,r){return"".concat(e).concat(n[r]).concat(t)})),this._program=setupProgram(this._gl,this._vertex,this._fragment),Object.keys(this._variables).forEach(function(e){if(!t._variables[e].linked){var r=t._variables[e],n=r.name,a=r.location,i=r.locationType,o=t._gl.getUniformLocation(t._program,n);t._gl[i](o,t._variables[e].value),t._locations[a]=o,t._variables[e].linked=!0}}),Object.keys(this._textures).forEach(function(e){if(!t._textures[e].linked){var r=t._textures[e],n=r.name,a=r.index,i=r.pSource;t._textures[e].linked=!0;var o=createTexture(t._gl,t._program,a+1,n);t._textures[e].apply=o.apply,i.then(function(e){o.apply(e)})}})}},{key:"render",value:function(){var e=this;if(!this._destroyed){this._gl.clear(this._gl.COLOR_BUFFER_BIT),this._gl.drawArrays(this._gl.TRIANGLES,0,6);var t=this._variables.u_time,r=t.locationType,n=t.location;this._gl[r](this._locations[n],(Date.now()-this._initTime)/1e3),requestAnimationFrame(function(t){return e.render()})}}},{key:"kill",value:function(){this._destroyed=!0,this._gl.getExtension("WEBGL_lose_context").loseContext(),this._gl.useProgram(null),this._gl.deleteProgram(this._program)}}]),e}();function setupProgram(e,t,r){var n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW);var a=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(a,t),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(a));var i=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(i,r),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(i));var o=e.createProgram();e.attachShader(o,a),e.attachShader(o,i),e.linkProgram(o),e.useProgram(o);var s=e.getAttribLocation(o,"a_position");return e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),o}function createTexture(e,t,r,n){var a=e.createTexture();e.bindTexture(e.TEXTURE_2D,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.uniform1i(e.getUniformLocation(t,n),r);var i=e["TEXTURE".concat(r)];return e.activeTexture(i),e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,new ImageData(2,2)),{apply:function(t){e.activeTexture(i),e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)},texture:a}}function stringifyVariables(e){return Object.keys(e).reduce(function(t,r){return"".concat(t,"\n\t\tuniform ").concat(e[r].type," ").concat(r).concat(e[r].size,";")},"")}function stringifyTextures(e){return Object.keys(e).reduce(function(e,t){return"".concat(e,"\n\t\tuniform sampler2D ").concat(t,";")},"")}module.exports=GLSL;