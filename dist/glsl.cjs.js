"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){var r=[],a=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(a=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);a=!0);}catch(e){n=!0,i=e}finally{try{a||null==s.return||s.return()}finally{if(n)throw i}}return r}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function getCanvas(e,t){var r=Object.assign({antialias:!1},t);if(e instanceof HTMLCanvasElement){var a={width:e.width,height:e.height,antialias:r.antialias};return new Canvas(e,a)}if(Array.isArray(e)){var n={width:e[0],height:e[1],antialias:r.antialias},i=document.createElement("canvas");return new Canvas(i,n)}throw new Error("getCanvas expects an HTMLCanvasElement or an Array [width, height]")}var Canvas=function(){function e(t,r){var a=r.width,n=r.height,i=r.antialias;_classCallCheck(this,e),this._canvas=t;try{this._context=t.getContext("webgl2",{antialias:i})}catch(e){throw new Error("Error while getting the context. ".concat(e.message))}t.width=a,t.height=n}return _createClass(e,[{key:"context",get:function(){return this._context}},{key:"node",get:function(){return this._canvas}},{key:"height",get:function(){return this._canvas.height}},{key:"width",get:function(){return this._canvas.width}}]),e}(),FLOAT_VARIABLES={float:"uniform1f",vec2:"uniform2fv",vec3:"uniform3fv",vec4:"uniform4fv"};function variableHelper(e,t,r){var a=asArray(t),n=_slicedToArray(getType(a,r),2),i=n[0],o=n[1],s=FLOAT_VARIABLES[i];return{name:e,linked:!1,value:a,type:i,size:o,location:"".concat(e,"Location"),locationType:s}}function textureHelper(e,t,r){return{apply:noop,name:e,index:t,pSource:"string"==typeof r?pGetImage(r):r instanceof Blob?pGetBlob(r).then(pGetImage):Promise.resolve(r),linked:!1}}function asArray(e){return Array.isArray(e)?e:[e]}function pGetImage(e){var t=new Image;return t.crossOrigin="Anonymous",new Promise(function(r){t.addEventListener("load",function(e){return r(t)}),t.src=e})}function pGetBlob(e){var t=new FileReader;return new Promise(function(r){t.addEventListener("load",function(e){r(e.target.result)}),t.readAsDataURL(e)})}function getType(e,t){return t?[t,"[".concat(e.length,"]")]:1===e.length?["float",""]:["vec".concat(e.length),""]}function noop(){}var PRECISION=["lowp","mediump","highp"],GLSL=function(){function e(t,r){_classCallCheck(this,e),this._options=Object.assign({antialias:!1,precision:1},r),this._canvas=getCanvas(t,this._options),this._gl=this._canvas.context,this._gl.viewport(0,0,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight),this._locations={},this._variables={},this._textures={},this._vertex="#version 300 es\n    in vec2 a_position;\n\n\t\tvoid main() {\n\t\t\tgl_Position = vec4(a_position, 0, 1);\n\t\t}",this._initTime=Date.now(),this.addVariable("u_time",0),this.addVariable("u_resolution",[this._canvas.width,this._canvas.height])}return _createClass(e,[{key:"canvas",get:function(){return this._canvas.node}}]),_createClass(e,[{key:"addVariable",value:function(e,t){var r=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(this._variables.hasOwnProperty(e))throw new Error("Variable ".concat(e," has already been added to this instance."));return this._variables[e]=variableHelper(e,t,a),function(t){var a=r._variables[e],n=a.location,i=a.locationType;r._variables[e].value=t,r._gl[i](r._locations[n],r._variables[e].value)}}},{key:"addTexture",value:function(e,t){var r=this;if(this._textures.hasOwnProperty(e))throw new Error("Texture ".concat(e," has already been added to this instance."));var a=Object.keys(this._textures).length;return this._textures[e]=textureHelper(e,a,t),function(t){r._textures[e].apply(t)}}},{key:"fragment",value:function(e){for(var t=this,r=arguments.length,a=new Array(r>1?r-1:0),n=1;n<r;n++)a[n-1]=arguments[n];var i=Array.isArray(e)?e:[e];if(a.length!==i.length-1)throw new Error("The fragment shader provided has an invalid amount of arguments");this._fragment="#version 300 es\n    precision ".concat(PRECISION[this._options.precision]," float;\n\n    out vec4 fragColor;\n\t\t\n\t\t").concat(stringifyVariables(this._variables),"\n\t\t\n\t\t").concat(stringifyTextures(this._textures),"\n\t\t\n\t\t").concat(i.reduce(function(e,t,r){return"".concat(e).concat(a[r]).concat(t)})),this._program=setupProgram(this._gl,this._vertex,this._fragment),Object.keys(this._variables).forEach(function(e){if(!t._variables[e].linked){var r=t._variables[e],a=r.name,n=r.location,i=r.locationType,o=t._gl.getUniformLocation(t._program,a);t._gl[i](o,t._variables[e].value),t._locations[n]=o,t._variables[e].linked=!0}}),Object.keys(this._textures).forEach(function(e){if(!t._textures[e].linked){var r=t._textures[e],a=r.name,n=r.index,i=r.pSource;t._textures[e].linked=!0;var o=createTexture(t._gl,t._program,n+1,a);t._textures[e].apply=o.apply,i.then(function(e){o.apply(e)})}})}},{key:"render",value:function(){var e=this;this._gl.clear(this._gl.COLOR_BUFFER_BIT),this._gl.drawArrays(this._gl.TRIANGLES,0,6);var t=this._variables.u_time,r=t.locationType,a=t.location;this._gl[r](this._locations[a],(Date.now()-this._initTime)/1e3),requestAnimationFrame(function(t){return e.render()})}},{key:"kill",value:function(){this._gl.getExtension("WEBGL_lose_context").loseContext(),this._gl.useProgram(null),this._gl.deleteProgram(this._program)}}]),e}();function setupProgram(e,t,r){var a=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW);var n=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(n,t),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(n));var i=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(i,r),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(i));var o=e.createProgram();e.attachShader(o,n),e.attachShader(o,i),e.linkProgram(o),e.useProgram(o);var s=e.getAttribLocation(o,"a_position");return e.enableVertexAttribArray(s),e.vertexAttribPointer(s,2,e.FLOAT,!1,0,0),o}function createTexture(e,t,r,a){var n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.uniform1i(e.getUniformLocation(t,a),r);var i=e["TEXTURE".concat(r)];return e.activeTexture(i),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,new ImageData(2,2)),{apply:function(t){e.activeTexture(i),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)},texture:n}}function stringifyVariables(e){return Object.keys(e).reduce(function(t,r){return"".concat(t,"\n\t\tuniform ").concat(e[r].type," ").concat(r).concat(e[r].size,";")},"")}function stringifyTextures(e){return Object.keys(e).reduce(function(e,t){return"".concat(e,"\n\t\tuniform sampler2D ").concat(t,";")},"")}module.exports=GLSL;