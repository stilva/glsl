"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var a=e[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _iterableToArrayLimit(t,e){var r=[],a=!0,n=!1,i=void 0;try{for(var o,s=t[Symbol.iterator]();!(a=(o=s.next()).done)&&(r.push(o.value),!e||r.length!==e);a=!0);}catch(t){n=!0,i=t}finally{try{a||null==s.return||s.return()}finally{if(n)throw i}}return r}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function getCanvas(t,e){var r=Object.assign({antialias:!1},e);if(t instanceof HTMLCanvasElement){var a={width:t.width,height:t.height,antialias:r.antialias};return new Canvas(t,a)}if(Array.isArray(t)){var n={width:t[0],height:t[1],antialias:r.antialias},i=document.createElement("canvas");return new Canvas(i,n)}throw new Error("getCanvas expects an HTMLCanvasElement or an Array [width, height]")}var Canvas=function(){function t(e,r){var a=r.width,n=r.height,i=r.antialias;_classCallCheck(this,t),this._canvas=e;try{this._context=e.getContext("webgl",{antialias:i})}catch(t){throw new Error("Error while getting the context. ".concat(t.message))}e.width=a,e.height=n}return _createClass(t,[{key:"context",get:function(){return this._context}},{key:"node",get:function(){return this._canvas}},{key:"height",get:function(){return this._canvas.height}},{key:"width",get:function(){return this._canvas.width}}]),t}(),FLOAT_VARIABLES={float:"uniform1f",vec2:"uniform2fv",vec3:"uniform3fv",vec4:"uniform4fv"};function variableHelper(t,e){var r=asArray(e),a=_slicedToArray(getType(r),2),n=a[0],i=a[1],o=FLOAT_VARIABLES[n];return{name:t,linked:!1,value:r,type:n,size:i,location:"".concat(t,"Location"),locationType:o}}function textureHelper(t,e,r){return{apply:noop,name:t,index:e,pSource:"string"==typeof r?pGetImage(r):r instanceof Blob?pGetBlob(r).then(pGetImage):Promise.resolve(r),linked:!1}}function asArray(t){return Array.isArray(t)?t:[t]}function pGetImage(t){var e=new Image;return e.crossOrigin="Anonymous",new Promise(function(r){e.addEventListener("load",function(t){return r(e)}),e.src=t})}function pGetBlob(t){var e=new FileReader;return new Promise(function(r){e.addEventListener("load",function(t){r(t.target.result)}),e.readAsDataURL(t)})}function getType(t){return Array.isArray(t[0])?1===t[0].length?["float","[".concat(t.length,"]")]:["vec".concat(t[0].length),"[".concat(t.length,"]")]:1===t.length?["float",""]:["vec".concat(t.length),""]}function noop(){}var PRECISION=["lowp","mediump","highp"],GLSL=function(){function t(e,r){_classCallCheck(this,t),this._options=Object.assign({antialias:!1,precision:1},r),this._canvas=getCanvas(e,this._options),this._gl=this._canvas.context,this._gl.viewport(0,0,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight),this._locations={},this._variables={},this._textures={},this._vertex="attribute vec2 a_position;\n\t\tvoid main() {\n\t\t\tgl_Position = vec4(a_position, 0, 1);\n\t\t}",this._initTime=Date.now(),this.addVariable("u_time",0),this.addVariable("u_resolution",[this._canvas.width,this._canvas.height])}return _createClass(t,[{key:"canvas",get:function(){return this._canvas.node}}]),_createClass(t,[{key:"addVariable",value:function(t,e){var r=this;if(this._variables.hasOwnProperty(t))throw new Error("Variable ".concat(t," has already been added to this instance."));return this._variables[t]=variableHelper(t,e),function(e){var a=r._variables[t],n=a.location,i=a.locationType;r._variables[t].value=e,r._gl[i](r._locations[n],r._variables[t].value)}}},{key:"addTexture",value:function(t,e){var r=this;if(this._textures.hasOwnProperty(t))throw new Error("Texture ".concat(t," has already been added to this instance."));var a=Object.keys(this._textures).length;return this._textures[t]=textureHelper(t,a,e),function(e){r._textures[t].apply(e)}}},{key:"fragment",value:function(t){for(var e=this,r=arguments.length,a=new Array(r>1?r-1:0),n=1;n<r;n++)a[n-1]=arguments[n];var i=Array.isArray(t)?t:[t];if(a.length!==i.length-1)throw new Error("The fragment shader provided has an invalid amount of arguments");this._fragment="precision ".concat(PRECISION[this._options.precision]," float;\n\t\t\n\t\t").concat(stringifyVariables(this._variables),"\n\t\t\n\t\t").concat(stringifyTextures(this._textures),"\n\t\t\n\t\t").concat(i.reduce(function(t,e,r){return"".concat(t).concat(a[r]).concat(e)})),this._program=setupProgram(this._gl,this._vertex,this._fragment),Object.keys(this._variables).forEach(function(t){if(!e._variables[t].linked){var r=e._variables[t],a=r.name,n=r.location,i=r.locationType,o=e._gl.getUniformLocation(e._program,a);e._gl[i](o,e._variables[t].value),e._locations[n]=o,e._variables[t].linked=!0}}),Object.keys(this._textures).forEach(function(t){if(!e._textures[t].linked){var r=e._textures[t],a=r.name,n=r.index,i=r.pSource;e._textures[t].linked=!0;var o=createTexture(e._gl,e._program,n+1,a);e._textures[t].apply=o.apply,i.then(function(t){o.apply(t)})}})}},{key:"render",value:function(){var t=this;this._gl.clear(this._gl.COLOR_BUFFER_BIT),this._gl.drawArrays(this._gl.TRIANGLES,0,6);var e=this._variables.u_time,r=e.locationType,a=e.location;this._gl[r](this._locations[a],(Date.now()-this._initTime)/1e3),requestAnimationFrame(function(e){return t.render()})}},{key:"kill",value:function(){this._gl.getExtension("WEBGL_lose_context").loseContext(),this._gl.useProgram(null),this._gl.deleteProgram(this._program)}}]),t}();function setupProgram(t,e,r){var a=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,a),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),t.STATIC_DRAW);var n=t.createShader(t.VERTEX_SHADER);t.shaderSource(n,e),t.compileShader(n);var i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(i,r),t.compileShader(i);var o=t.createProgram();t.attachShader(o,n),t.attachShader(o,i),t.linkProgram(o),t.useProgram(o);var s=t.getAttribLocation(o,"a_position");return t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),o}function createTexture(t,e,r,a){var n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.uniform1i(t.getUniformLocation(e,a),r);var i=t["TEXTURE".concat(r)];return t.activeTexture(i),t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,new ImageData(2,2)),{apply:function(e){t.activeTexture(i),t.bindTexture(t.TEXTURE_2D,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)},texture:n}}function stringifyVariables(t){return Object.keys(t).reduce(function(e,r){return"".concat(e,"\n\t\tuniform ").concat(t[r].type," ").concat(r).concat(t[r].size,";")},"")}function stringifyTextures(t){return Object.keys(t).reduce(function(t,e){return"".concat(t,"\n\t\tuniform sampler2D ").concat(e,";")},"")}module.exports=GLSL;